import fetch from 'node-fetch';

const GNEWS_API_KEY = '4062dec5ad3c4197e17922fe1806cf11';
const INTERVAL = 1000 * 60 * 10;
const cache = {};

async function getNews(topic = 'calcio OR Serie A OR Champions League OR UEFA OR Sky Sport OR Gazzetta') {
  try {
    const res = await fetch(`https://gnews.io/api/v4/search?q=${encodeURIComponent(topic)}&lang=it&max=6&apikey=${GNEWS_API_KEY}`);
    const json = await res.json();

    if (!json.articles || json.articles.length === 0) return null;

    let text = `ğŸ“¢ *Ultime Notizie Calcio â€“ ${new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}*\n\n`;

    for (const a of json.articles) {
      text += `ğŸ“° *${a.title}*\n`;
      text += `ğŸ“Œ ${a.source.name} â€“ ğŸ•’ ${a.publishedAt.replace('T', ' ').replace('Z', '')}\n`;
      text += `ğŸ”— ${a.url}\n\n`;
    }

    return text.trim();
  } catch (err) {
    console.error('Errore nel recupero delle news:', err);
    return 'âŒ Errore durante il recupero delle notizie.';
  }
}

let autoNewsHandler = async (m, { conn }) => {
  const id = m.chat;
  const now = Date.now();

  if (!cache[id] || now - cache[id] > INTERVAL) {
    const news = await getNews();
    if (news) {
      cache[id] = now;
      await conn.sendMessage(id, {
        text: news,
        footer: 'ğŸ—ï¸ Powered by GNews â€¢ news automatica ogni 10 min',
        headerType: 1
      }, { quoted: m });
    }
  }
};
autoNewsHandler.all = autoNewsHandler;

// ğŸ”˜ Comando manuale .news
autoNewsHandler.command = /^news$/i;
autoNewsHandler.tags = ['news'];
autoNewsHandler.help = ['news'];
autoNewsHandler.disabled = false;

autoNewsHandler.handler = async (m, { conn }) => {
  const news = await getNews();
  await conn.sendMessage(m.chat, {
    text: news || 'ğŸ“­ Nessuna notizia trovata.',
    footer: 'ğŸ—ï¸ Notizie richieste manualmente',
    headerType: 1
  }, { quoted: m });
};

export default autoNewsHandler;
